<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>RDP</title>
    <style>
        #display {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-position: center;
            background-repeat: no-repeat;
            background-size: cover;
            -webkit-background-size: cover;
            -o-background-size: cover;
        }
    </style>
</head>

<body>
<div id="display"></div>
</body>

<script type="text/javascript" src="/static/guacamole-common-js/all.min.js"></script>
<script type="text/javascript" src="/app_config.js"></script>
<script type="text/javascript">

    //获取URL参数
    function getQueryVariable(variable) {
        var query = window.location.search.substring(1);
        var vars = query.split("&");
        for (var i = 0; i < vars.length; i++) {
            var pair = vars[i].split("=");
            if (pair[0] == variable) {
                return pair[1];
            }
        }
        return "";
    }

    var serverId = getQueryVariable("serverId");
    var accountId = getQueryVariable("accountId");

    //当前窗口宽高
    var webClientWidth = window.innerWidth;
    var webClientHeight = window.innerHeight;

    //设置web socket地址及传入参数
    var guac = new Guacamole.Client(
        new Guacamole.WebSocketTunnel("/webRDP?w=" + webClientWidth + "&h=" + webClientHeight + "&serverId=" + serverId + "&accountId=" + accountId +'&')
    );

    var display = document.getElementById("display");
    display.appendChild(guac.getDisplay().getElement());

    guac.onerror = function (error) {
        //当远程服务器连不上、有其他用户顶替登录等异常断开时，会执行当前回调，可通过error.message区分
        //TODO：这里可以提示用户重新连接或关闭
        alert("断开连接" + error.message);
        console.log(error);
    };

    guac.connect();

    window.onunload = function () {
        //断开连接
        guac.disconnect();
    }

    //鼠标事件
    var mouse = new Guacamole.Mouse(guac.getDisplay().getElement());
    mouse.onmousedown =
        mouse.onmouseup =
            mouse.onmousemove = function (mouseState) {
                guac.sendMouseState(mouseState);
            };
    //键盘事件
    var keyboard = new Guacamole.Keyboard(document);
    keyboard.onkeydown = function (keysym) {
        guac.sendKeyEvent(1, keysym);
    };
    keyboard.onkeyup = function (keysym) {
        guac.sendKeyEvent(0, keysym);
    };
</script>
</html>